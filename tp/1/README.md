 ## TP1 : (re)Familiaration avec un système GNU/Linux
 
 ### 0. Préparation de la machine
 
 🌞 Setup de deux machines Rocky Linux configurée de façon basique :
 
 **un accès internet (via la carte NAT)**

- carte réseau dédiée
- route par défaut

![](https://i.imgur.com/4d3sF7d.png)

![](https://i.imgur.com/tTRGQYT.png)





**Configuration de la carte :**

`sudo nano /etc/sysconfig/network-scripts/ifcfg-enp0s8`

```
NAME = enp0s8
DEVICE=enp0s8

BOOTPROTO = static
ONBOOT=yes

IPADDR=10.101.1.11
NETMASK=255.255.255.0
```


**Preuve que la configuration fonctionne :**

`ip a`


![](https://i.imgur.com/rvfFE8O.png)


**Ping vers l'autre machine :**

`ping 10.101.1.12`

![](https://i.imgur.com/Cy0d6B2.png)


**Modification des noms des machines :**

`sudo nano /etc/hostname`

```
[paul@node1 .ssh]$ [paul@node1 .ssh]$ sudo cat /etc/hostname
node1.tp1.b2
```

**Utiliser 1.1.1.1 comme serveur DNS :**

`sudo nano /etc/resolv.conf`

```
[paul@node1 .ssh]$ [paul@node1 .ssh]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
search tp1.b2
nameserver 1.1.1.1
```


**Demander une résolution du nom ynov.com :**

```
sudo dnf install bind-utils
dig ynov.com
```

![](https://i.imgur.com/5vnIf6J.png)


**Les machines doivent pouvoir se joindre par leurs noms respectifs :**

`sudo nano /etc/hosts`

![](https://i.imgur.com/G5lKH3j.png)



`ping node2.tp1.b2`

![](https://i.imgur.com/6AQdCt5.png)

**🌞 Ajouter un utilisateur à la machine, qui sera dédié à son administration. Précisez des options sur la commande d'ajout pour que :**

* Création d'un user

`groups`

![](https://i.imgur.com/ypNMOdK.png)


* Modification de la conf sudo

`sudo cat /etc/sudoers`

![](https://i.imgur.com/pZBTvBN.png)

![](https://i.imgur.com/sJs7NiY.png)

**🌞 Créer un nouveau groupe admins qui contiendra les utilisateurs de la machine ayant accès aux droits de root via la commande sudo.**


`groupadd admins`

`[paul@node1 ~]$ sudo visudo /etc/sudoers`

```
## Allows people in group admins to run all commands
%admins ALL=(ALL)       ALL
```

🌞 Ajouter votre utilisateur à ce groupe admins.

`[paul@node1 ~]$ sudo usermod -aG admins paul`

🌞 déposer la clé dans le fichier `/home/paul/.ssh/authorized_keys` de la machine que l'on souhaite administrer
```

[paul@node1 .ssh]$ cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCx4Dhm8vcoliXlB9OMDISSKBYpeeCGlsyKtm9piVZMc82rVk3KVLHs7kak5m29zHBM536MYFjOYGhi9JU0l7rP1PLA7bqm68ESYkyrRp0N/QIO+xG+tu92aJ6ldn3jPbF8otVaMaYBCyHmC6t7ZRv0h1uK8Swr7ePyXZ5dOwZ12Fv+c/K7UvEUkgnjw4O4CMhCBPFI6AgUpSH9NZxRhncvcFwBJ+iPA2g6pFIGUoPqaZuoZK6RI6l/43EFIrMtkGy28xe4f6ZbpVL7lNOeGLngmoPPjKrpfRlCJI/inJ1i6h/KnsJdMwPS9yJcLVF+lxuVz592j7ksZSegCO5sau8nGhF+wCpJUoCXMFFW1E8nzDAt6l2KYq5RZSLMvYJ4SAaqi0ZITtJxrG4uZccIQ84u/Il8FbHgzM7hIXoCVStM9EI+dpGJCkJMyDVvNO+CGjuPfNkCtDX6i8Sk9Zej4YAHclmBVEV9nNjJx3E8qZkHVc/djNioMzGb1tIfoD+euLs9jjsz4ORO/FToqZicrpxw90e3gOI8dC66rqRy+FGRCDoE4NFLdnaIAmTgxTvwuU/KAfLh10sdedL9kuQnCmp8yLARgUkGwXt9X1piSwSSpg3NSMybg3XOW5Wm6VALoqFOWB2+7h3YFCXzuSI/6Elm41O/cEYtc/WzsIGJhfYHCw== paul@DESKTOP-DM8M0FQ
```

🌞 Assurez vous que la connexion SSH est fonctionnelle, sans avoir besoin de mot de passe.

```
PS C:\Users\Paul> ssh paul@10.101.1.11
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Sat Sep 25 11:15:51 2021 from 10.101.1.1
[paul@node1 ~]$
```

### II. Partitionnement

**1. Préparation de la VM**

* **Ajout de deux disques durs à la machine virtuelle, de 3Go chacun.**

Cela se fais sur les paramètres de la VM sur Virtual Box

🌞 Utilisez LVM pour :

* **agréger les deux disques en un seul volume group**

```
$ sudo pvcreate /dev/sdb
$ sudo pvcreate /dev/sdc
```

`$ sudo vgcreate data /dev/sdb`

```
$ sudo vgextend data /dev/sdc
$ sudo vgextend data /dev/sdb
```

* **créer 3 logical volumes de 1 Go chacun**

```
sudo lvcreate -L 1G data -n volume_1
sudo lvcreate -L 1G data -n volume_2
sudo lvcreate -L 1G data -n volume_3
```

* **formater ces partitions en ext4**

```
sudo mkfs -t ext4 /dev/data/volume_1

sudo mkfs -t ext4 /dev/data/volume_2

sudo mkfs -t ext4 /dev/data/volume_3
```

* **monter ces partitions pour qu'elles soient accessibles aux points de montage /mnt/part1, /mnt/part2 et /mnt/part3.**

`$ mkdir /mnt/part1`

`$ mkdir /mnt/part2`

`$ mkdir /mnt/part3`

```
sudo mount /dev/data/volume_1 /mnt/part1

sudo mount /dev/data/volume_2 /mnt/part2

sudo mount /dev/data/volume_3 /mnt/part3
```

**🌞 Grâce au fichier /etc/fstab, faites en sorte que cette partition soit montée automatiquement au démarrage du système.**

`$ sudo nano /etc/fstab`

```
/dev/data/volume_1 /mnt/part1 ext4 defaults 0 0
/dev/data/volume_2 /mnt/part2 ext4 defaults 0 0
/dev/data/volume_3 /mnt/part3 ext4 defaults 0 0
```

### III. Gestion de services

#### 1. Interaction avec un service existant

**🌞 Assurez-vous que :**

* l'unitée est activée (elle se lance automatiquement au démarrage)

```
[paul@node1 ~]$ sudo nano /etc/fstab
[sudo] password for paul:
[paul@node1 ~]$ [paul@node1 ~]$ systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2021-09-25 11:27:19 CEST; 21min ago
     Docs: man:firewalld(1)
 Main PID: 821 (firewalld)
    Tasks: 2 (limit: 11397)
   Memory: 30.4M
   CGroup: /system.slice/firewalld.service
           └─821 /usr/libexec/platform-python -s /usr/sbin/firewalld --nofork --nopid
```

#### 2. Création de service

**🌞 Créer un fichier qui définit une unité de service web.service dans le répertoire /etc/systemd/system.**

`cd /etc/systemd/system`

`touch web.service`

`sudo nano web.service`

Le but de cette unité est de lancer un serveur web sur le port 8888 de la machine. N'oubliez pas d'ouvrir ce port.

`sudo firewall-cmd --add-port=8888/tcp --permanent`

`sudo firewall-cmd --reload`

`sudo systemctl daemon-reload`

```
sudo systemctl status web
● web.service - Very simple web service
   Loaded: loaded (/etc/systemd/system/web.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
```

```
sudo systemctl start web
[paul@node1 ~]$ sudo systemctl enable web
Created symlink /etc/systemd/system/multi-user.target.wants/web.service → /etc/systemd/system/web.service.
```

 ```
sudo systemctl status web
[sudo] password for paul:
● web.service - Very simple web service
   Loaded: loaded (/etc/systemd/system/web.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2021-09-23 11:36:25 CEST; 20s ago
 Main PID: 878 (python3)
    Tasks: 1 (limit: 11397)
   Memory: 13.6M
   CGroup: /system.slice/web.service
           └─878 /bin/python3 -m http.server 8888
```

🌞Une fois le service démarré, assurez-vous que pouvez accéder au serveur web : avec un navigateur ou la commande curl sur l'IP de la VM, port 8888.

![](https://i.imgur.com/QX5q6FS.png)

B. Modification de l'unité

🌞 Créer un utilisateur web.

`sudo useradd web`

🌞 Modifiez l'unité de service web.service créée précédemment en ajoutant les clauses :

`User =` pour lancer le serveur avec l'utilisateur

`WorkingDirectory=` afin de lancer le serveur depuis un dossier spécifique, choisissez un dossier que vous avez créé dans `/srv`.

Il faudra donc mettre tous sa dans section SERVICE de l'unité

```
[Unit]
Description=Very simple web service

[Service]
ExecStart=/bin/python3 -m http.server 8888
User=web
WorkingDirectory=/srv/web
[Install]
WantedBy=multi-user.target
```

🌞 Placer un fichier de votre choix dans le dossier créé dans /srv et tester que vous pouvez y accéder une fois le service actif. Il faudra que le dossier et le fichier qu'il contient appartiennent à l'utilisateur web.

`cd /srv/web`

`nano test.txt`

🌞 Vérifier le bon fonctionnement avec une commande curl

[paul@node1 ~]$ curl 10.101.1.11:8888/srv/web/test.txt
Test

